/**
 * @file    modbus_config.h
 * @brief   Modbus从站配置文件
 * @details 包含硬件接口、通信参数、寄存器数量等可配置项
 */

#ifndef MODBUS_CONFIG_H
#define MODBUS_CONFIG_H

#include "main.h"  /* 包含HAL库定义及UART句柄声明 */

/* ============================================================================
 *                              硬件接口配置
 * ============================================================================ */

/**
 * @brief   Modbus通信使用的UART句柄
 * @note    需与CubeMX中配置的UART实例保持一致，如 &huart1、&huart2 等
 */
extern UART_HandleTypeDef huart2;
#define MODBUS_UART_HANDLE      &huart2

/* ============================================================================
 *                              物理层接口配置
 * ============================================================================ */

/**
 * @brief   物理层接口类型选择
 * @arg     0: RS232/TTL模式（全双工，无需方向控制）
 * @arg     1: RS485模式（半双工，需控制DE/RE引脚）
 */
#define MODBUS_USE_RS485        1

/**
 * @brief   RS485收发控制引脚配置
 * @note    仅在 MODBUS_USE_RS485 = 1 时生效
 *          请在CubeMX中将该引脚配置为GPIO_Output模式
 */
#define RS485_PORT              GPIOD
#define RS485_PIN               GPIO_PIN_7

/**
 * @brief   RS485收发方向控制宏
 * @note    根据实际硬件电路调整电平逻辑
 *          典型设计：高电平=发送使能，低电平=接收使能
 */
#define RS485_TX_ENABLE()       HAL_GPIO_WritePin(RS485_PORT, RS485_PIN, GPIO_PIN_SET)
#define RS485_RX_ENABLE()       HAL_GPIO_WritePin(RS485_PORT, RS485_PIN, GPIO_PIN_RESET)

/* ============================================================================
 *                              Flash存储配置
 * ============================================================================ */

/**
 * @brief   配置参数存储的Flash地址
 * @warning 该地址所在页/扇区的数据会在保存配置时被擦除
 * @note    请根据芯片型号选择合适的地址：
 *          - STM32F103C8T6 (64KB Flash): 最后1KB页 = 0x0800FC00
 *          - STM32F103RCT6 (256KB Flash): 最后1KB页 = 0x0803FC00
 *          - STM32F407VET6 (512KB Flash): 扇区11 = 0x080E0000
 */
#define MODBUS_FLASH_ADDR       0x0800F800

/* ============================================================================
 *                              Modbus默认参数
 * ============================================================================ */

/**
 * @brief   Flash首次使用或校验失败时的默认配置
 */
#define DEFAULT_SLAVE_ADDR      0x01    /* 默认从站地址 (有效范围: 1~247) */
#define DEFAULT_BAUD_RATE       9600    /* 默认波特率 */

/* ============================================================================
 *                              寄存器容量配置
 * ============================================================================ */

/**
 * @brief   各类型寄存器/线圈的最大数量
 * @note    设为0可禁用对应功能码，减少代码体积
 */
#define MB_COIL_COUNT           8   /* 线圈数量 (功能码: 01/05/0F) */
#define MB_DISCRETE_COUNT       8   /* 离散输入数量 (功能码: 02) */
#define MB_HOLDING_REG_COUNT    8   /* 保持寄存器数量 (功能码: 03/06/10) */
#define MB_INPUT_REG_COUNT      8   /* 输入寄存器数量 (功能码: 04) */

/**
 * @brief   通信缓冲区大小
 * @note    应大于最大Modbus帧长度，256字节足以满足标准协议需求
 */
#define MB_RX_BUF_SIZE          256
#define MB_TX_BUF_SIZE          256

/* ============================================================================
 *                              CRC算法配置
 * ============================================================================ */

/**
 * @brief   CRC16计算算法选择
 * @arg     0: 移位法 (默认) - 代码体积小，但计算较慢
 * @arg     1: 查表法 - 计算速度快约10倍，但需额外512字节ROM
 * @note    选择建议:
 *          - ROM空间紧张: 使用移位法 (0)
 *          - 高速率通信(115200+): 使用查表法 (1)
 */
#define MODBUS_CRC_USE_TABLE    0

#endif /* MODBUS_CONFIG_H */
